name: ğŸ³ Production CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  # Environment variables
  DOCKER_IMAGE_BACKEND: trending-backend
  DOCKER_IMAGE_FRONTEND: trending-frontend
  DOCKER_TAG: ${{ github.sha }}
  REGISTRY: docker.io
  POSTGRES_DB: trending_db
  POSTGRES_USER: user
  POSTGRES_PASSWORD: 28092004

jobs:
  # GIAI ÄOáº N 1: TESTING
  test-services:
    name: "ğŸ§ª Test Services"
    runs-on: ubuntu-latest

    services:
      # PostgreSQL service for testing
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      # Elasticsearch service for testing
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.1
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          xpack.security.enrollment.enabled: false
          ES_JAVA_OPTS: -Xms512m -Xmx512m
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
        ports:
          - 9200:9200

    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ğŸ³ Build services for testing"
        run: |
          docker-compose -f docker-compose.yml build backend frontend

      - name: "ğŸ§ª Run backend tests"
        run: |
          docker-compose -f docker-compose.yml run --rm backend python -m pytest tests/ -v
          # Hoáº·c npm test náº¿u backend lÃ  Node.js

      - name: "ğŸ§ª Run frontend tests"
        run: |
          docker-compose -f docker-compose.yml run --rm frontend npm test -- --coverage --watchAll=false

      - name: "ğŸ”— Test service connectivity"
        run: |
          # Test database connection
          docker-compose -f docker-compose.yml run --rm backend python -c "
          import psycopg2
          conn = psycopg2.connect(
              dbname='$POSTGRES_DB',
              user='$POSTGRES_USER', 
              password='$POSTGRES_PASSWORD',
              host='postgres',
              port='5432'
          )
          print('âœ… Database connection successful')
          conn.close()
          "

          # Test Elasticsearch connection
          docker-compose -f docker-compose.yml run --rm backend python -c "
          import requests
          response = requests.get('http://elasticsearch:9200')
          print('âœ… Elasticsearch connection successful')
          "

  # GIAI ÄOáº N 2: BUILD & SECURITY SCAN
  build-and-scan:
    name: "ğŸ—ï¸ Build & Security Scan"
    runs-on: ubuntu-latest
    needs: test-services

    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ğŸ³ Build backend image"
        run: |
          docker build \
            -t ${{ env.DOCKER_IMAGE_BACKEND }}:${{ env.DOCKER_TAG }} \
            -t ${{ env.DOCKER_IMAGE_BACKEND }}:latest \
            ./backend

      - name: "ğŸ³ Build frontend image"
        run: |
          docker build \
            -t ${{ env.DOCKER_IMAGE_FRONTEND }}:${{ env.DOCKER_TAG }} \
            -t ${{ env.DOCKER_IMAGE_FRONTEND }}:latest \
            ./frontend

      - name: "ğŸ”’ Scan backend for vulnerabilities"
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE_BACKEND }}:${{ env.DOCKER_TAG }}
          format: sarif
          output: trivy-results-backend.sarif
          exit-code: 1

      - name: "ğŸ”’ Scan frontend for vulnerabilities"
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE_FRONTEND }}:${{ env.DOCKER_TAG }}
          format: sarif
          output: trivy-results-frontend.sarif
          exit-code: 1

      - name: "ğŸ“Š Upload security scan results"
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results-backend.sarif

      - name: "ğŸ³ Test built images"
        run: |
          # Test backend image
          docker run --rm -d --name test-backend ${{ env.DOCKER_IMAGE_BACKEND }}:${{ env.DOCKER_TAG }}
          sleep 10
          docker stop test-backend

          # Test frontend image  
          docker run --rm -d --name test-frontend ${{ env.DOCKER_IMAGE_FRONTEND }}:${{ env.DOCKER_TAG }}
          sleep 5
          docker stop test-frontend

  # GIAI ÄOáº N 3: PUSH TO REGISTRY
  push-to-registry:
    name: "ğŸ“¦ Push to Registry"
    runs-on: ubuntu-latest
    needs: build-and-scan
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ğŸ³ Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "ğŸ” Login to Docker Hub"
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: "ğŸ·ï¸ Build and push backend"
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_BACKEND }}:${{ env.DOCKER_TAG }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_BACKEND }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: "ğŸ·ï¸ Build and push frontend"
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_FRONTEND }}:${{ env.DOCKER_TAG }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_FRONTEND }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: "ğŸ“‹ Update image tags"
        run: |
          echo "Backend Image: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_BACKEND }}:${{ env.DOCKER_TAG }}"
          echo "Frontend Image: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.DOCKER_IMAGE_FRONTEND }}:${{ env.DOCKER_TAG }}"

  # GIAI ÄOáº N 4: INTEGRATION TEST
  integration-test:
    name: "ğŸ”— Integration Test"
    runs-on: ubuntu-latest
    needs: push-to-registry
    if: github.ref == 'refs/heads/main'

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.1
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: -Xms512m -Xmx512m
        options: >-
          --health-cmd "curl -f http://localhost:9200/_cluster/health || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
        ports:
          - 9200:9200

    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ğŸ³ Pull and run full stack"
        run: |
          # Pull images (trong thá»±c táº¿ sáº½ pull tá»« registry)
          docker-compose -f docker-compose.yml up -d postgres elasticsearch
          sleep 30  # Chá» services khá»Ÿi Ä‘á»™ng

          # Build vÃ  cháº¡y backend vá»›i production image
          docker-compose -f docker-compose.yml build backend
          docker-compose -f docker-compose.yml up -d backend
          sleep 20

          # Test API endpoints
          curl -f http://localhost:8000 || exit 1
          echo "âœ… Integration test passed"

      - name: "ğŸ§¹ Cleanup"
        if: always()
        run: docker-compose -f docker-compose.yml down
